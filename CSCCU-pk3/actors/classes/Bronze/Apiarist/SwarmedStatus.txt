actor SwarmedWatcher //: CustomInventory
{
+MISSILE
+RIPPER
+NOGRAVITY
+NOINTERACTION
Reactiontime 5
Obituary "%o succumed to %k's Swarming"
var int user_OwnerTID;
var int user_TickDamage;
var int user_LoopCount;
States
{
Spawn:
TNT1 A 0
// Sow e start by making this actor immediately set it's master to the spawner's target (last person to damage them)
// and then we set them to our tracer pointer.
//TNT1 A 0 A_GiveToTarget("FireCritAble",1)
LASH A 0 A_Setuservar("user_OwnerTID",ACS_ExecuteWithResult(257,0))
LASH A 0 A_TransferPointer(AAPTR_TARGET,AAPTR_DEFAULT,AAPTR_TARGET,AAPTR_MASTER,PTROP_NOSAFEGUARDS)
LASH A 0 A_ReArrangePointers(AAPTR_DEFAULT,AAPTR_DEFAULT,AAPTR_TARGET)
Spawn2:
TNT1 A 1 A_JumpIfInTargetInventory("CutterFlag",999,"DeathTake")
//TNT1 A 0 A_JumpIfInTargetInventory("TempFireProof",1,"DeathTake")
TNT1 A 0 A_GiveToTarget("SwarmedEffect",1)
TNT1 A 1 A_JumpIfInTargetInventory("CutterFlag",999,"DeathTake")
//TNT1 A 0 A_JumpIfInTargetInventory("TempFireProof",1,"DeathTake")
TNT1 A 0 A_GiveToTarget("SwarmedEffect",1)
TNT1 A 1 A_JumpIfInTargetInventory("CutterFlag",999,"DeathTake")
//TNT1 A 0 A_JumpIfInTargetInventory("TempFireProof",1,"DeathTake")
TNT1 A 0 A_GiveToTarget("SwarmedEffect",1)
TNT1 A 1 A_JumpIfInTargetInventory("CutterFlag",999,"DeathTake")
//TNT1 A 0 A_JumpIfInTargetInventory("TempFireProof",1,"DeathTake")
TNT1 A 0 A_GiveToTarget("SwarmedEffect",1)
TNT1 A 1 A_JumpIfInTargetInventory("CutterFlag",999,"DeathTake")
//TNT1 A 0 A_JumpIfInTargetInventory("TempFireProof",1,"DeathTake")


TNT1 A 0 A_SetuserVar("user_LoopCount", user_LoopCount+1)
TNT1 A 0 A_Jumpif( user_LoopCount <= 4,"Spawn2")
TNT1 A 0 A_SetuserVar("user_LoopCount", 0)

//TNT1 A 0 A_JumpIfInTargetInventory("ProtectorFlag",1,5)

// when we deal tick damage, we set the target to our master (the person responsible for inflicting the dot) and use this script
// to make them deal tick damage to the victim directly.
LASH A 0 A_ReArrangePointers(AAPTR_MASTER,AAPTR_DEFAULT,AAPTR_DEFAULT)
LASH A 0  ACS_NamedExecuteAlways("DotDamager", 0,3,user_OwnerTID) //DOT Script
LASH A 1 // this delay is important, otherwise it becomes a suicide
LASH A 0 A_ReArrangePointers(AAPTR_TRACER,AAPTR_DEFAULT,AAPTR_DEFAULT)
//now we set the target back to the spawner to keep the Swarm effect on them.
//TNT1 A 0 A_GiveToTarget("SwarmedDamage",1)
LASH A 0
TNT1 A 1 A_JumpIfInTargetInventory("SwarmedMark",1,"Spawn2")
//TNT1 A 1 A_TakefromTarget("FireCritAble",999)
stop
Death:
DeathTake:
TNT1 A 0 
TNT1 A 1 A_TakefromTarget("SwarmedMark",999)
stop
}
}


actor SwarmedEffect : CustomInventory
{
inventory.amount 1
inventory.maxamount 1
States
{
Spawn:
TNT1 A 0
stop
Pickup:
TNT1 A 0 //SetPlayerProperty(0,1,4)
TNT1 A 0 A_SpawnItemEx("BeeParticleFx",random(-24,24),random(-32,32),random(1,32),momx,momy,momz,random(0,360),SXF_ABSOLUTEMOMENTUM)
TNT1 A 0 //SetPlayerProperty(0,1,4)
stop
}
}

actor SwarmedMark : PowerSpeed
{
powerup.duration -4
speed 0.6
Powerup.Color Yellow, 0.15
}


actor SwarmStackDelay : powerup
{powerup.duration 5}

actor SwarmedFX1  //These are decorative.
{
PROJECTILE
+THRUACTORS
+NOGRAVITY
height 2
Radius 2
damage (0)
reactiontime 1
scale 1
RenderStyle "Add"
Alpha 0.5
States
{
Spawn:
BRNF AABBCCDDEEFGH 1 
Death:
TNT1 A 1
stop
}
}