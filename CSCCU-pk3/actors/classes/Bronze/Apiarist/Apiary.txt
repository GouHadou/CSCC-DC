const int ApiaryRadius = 350;
const int BEESHT_SPD = 74; 
const int BEESHT_SPD2 = 15; 
actor Apiary : DeployableBase
{

+Shootable
+DONTBLAST
+SKYEXPLODE
+DONTSEEKINVISIBLE//
+SEEKERMISSILE
+FLOORHUGGER
+QUICKTORETALIATE
+THRUSPECIES
//==
speed 1
DamageFactor "BigBee", 0
scale 0.8
Radius 15
Height 20
Health 80
gravity 999
reactiontime 256
PainChance 256

Var int User_Tally;
Var int User_HoneyTimer;
states
{

Spawn:
TNT1 A 0 
GESP G 0 
GESP G 0 ACS_NamedExecuteAlways("PlayerSpeciesSynch",0)
GESP G 0 ACS_NamedExecuteAlways("ObjectTally",0)
GESP G 1 A_RearrangePointers(AAPTR_DEFAULT, AAPTR_TARGET, AAPTR_DEFAULT) //set the owner to the master pointer
Idle:
GESP G 1 A_SetUserVar("User_HoneyTimer",User_HoneyTimer+1)
TRET A 0 A_Jumpif(User_HoneyTimer >= 35,"HoneyDrop")

GESP G 1 A_Lookex(LOF_NOSOUNDCHECK,1,ApiaryRadius,ApiaryRadius,360,"TargetCheck")//A_SeekerMissile(0,0,SMF_LOOK,100,BSEN_DetectRange)//TargetCheck
TRET A 0 A_Jumpif(user_tally >= 4,"Perish")
loop
HoneyDrop:
TRET A 0 A_PlaySoundEx("weapon/CrackerMine","Body")
TRET A 0 HealThing(20)
TRET A 0 A_SpawnItemEx("HoneyDrop",0,0,35,4,0,6,Random(0,360),SXF_TRANSFERPOINTERS|SXF_TRANSFERTRANSLATION)
GESP G 1 A_SetUserVar("User_HoneyTimer",0)
Goto Idle
TargetCheck:
GESP G 1 
//TRET A 1 A_Jumpifintargetinventory("SpyStealthActivate",1,"Scan",AAPTR_TARGET) //can't shoot what you can't see,
//TRET A 1 A_Jumpifintargetinventory("WilyTeamFlag",1,"Spotted") //found an enemy!
TRET A 0 A_checkflag("IsMonster","Spotted",AAPTR_TARGET) //found an enemy!
TRET A 0 A_JumpIf(IsPointerEqual(AAPTR_TARGET, AAPTR_MASTER) != TRUE, "Spotted")
Goto Idle
Spotted:
GESP G 1 
TRET A 0 A_RearrangePointers(AAPTR_MASTER, AAPTR_DEFAULT, AAPTR_TARGET)// set the target as our tracer, and the owner as our target again.
GESP G 1 
Missile:
TRET A 0 A_FaceTracer
TRET A 0 A_Changevelocity(0,0,0,CVF_REPLACE) //Prevents movement
TNT1 A 0 A_Stop
TRET A 0 ACS_NamedExecuteAlways("PitchToTracer",0,0)
GESP G 2 
TRET A 0 A_GiveInventory("ApiaryShooter")
TRET A 0 A_PlaySoundEx("weapon/hornethover","Body")
TRET A 0 A_Jumpif(user_tally >= 4,"Perish")
Afterfire:
GESP G 1 
TRET A 0 A_Jumpif(user_tally >= 4,"Perish")
TRET A 0 A_Jumpifinventory("CutterFlag",999,2,AAPTR_TRACER) //
TRET A 0 A_JumpIfTargetInLOS ("Missile", 0, JLOSF_PROJECTILE,ApiaryRadius  )//JLOSF_PROJECTILE
TRET A 0 
TRET A 0 A_RearrangePointers(AAPTR_DEFAULT, AAPTR_TARGET, AAPTR_NULL)
Goto Idle

Pain:
TRET A 1 A_Stop
TRET A 0 A_PlaySoundEx("misc/mm4pain", "Voice")
TRET A 0 A_Jumpif(user_tally >= 4,"Perish")

TRET A 0 A_FaceTracer
TRET A 0 A_Changevelocity(0,0,0,CVF_REPLACE) //Prevents movement
TNT1 A 0 A_Stop
TRET A 0 ACS_NamedExecuteAlways("PitchToTracer",0,0)

GESP G 0 
TRET A 0 A_GiveInventory("ApiaryShooter2")
TRET A 0 A_PlaySoundEx("weapon/hornetchaser","Body")
GESP G 2 
TRET A 0 A_GiveInventory("ApiaryShooter2")
TRET A 0 A_PlaySoundEx("weapon/hornetchaser","Body")
GESP G 2 
TRET A 0 A_GiveInventory("ApiaryShooter2")
TRET A 0 A_PlaySoundEx("weapon/hornetchaser","Body")
GESP G 2 
TRET A 0 A_GiveInventory("ApiaryShooter2")
TRET A 0 A_PlaySoundEx("weapon/hornetchaser","Body")


TRET A 0 A_RearrangePointers(AAPTR_MASTER, AAPTR_DEFAULT, AAPTR_DEFAULT) //reset target to master
Goto Idle

Death:
TRET A 0 A_RearrangePointers(AAPTR_MASTER, AAPTR_DEFAULT, AAPTR_DEFAULT) //reset target to master
TNT1 A 0 A_PlaySoundEx("weapon/napalm", "Weapon")
//TNT1 A 1 A_SpawnItemEx("ExplodeDeathFX1")
TNT1 A 0 ACS_NamedExecuteAlways("ObjectDeathTally",0)
TNT1 A 4
stop
Perish:
Terminate:
TNT1 A 0 
TNT1 A 4
stop
}
}

	actor Apiary_R : Apiary
	{
	translation "192:192=42:42", "198:198=42:42"
	Designatedteam 1
	Species "REDMember"
	States
	{
	TargetCheck:
	GESP G 1 
	TRET A 0 //A_Jumpifintargetinventory("RespawnCamera",1,"Scan") //can't shoot what you can't see,
	TRET A 0 A_Jumpifintargetinventory("LightTeamFlag",1,"Spotted") //found an enemy!
	TRET A 0 A_checkflag("IsMonster","Spotted",AAPTR_TARGET) //found an enemy!
	Goto Idle
	}
	}

	actor Apiary_B : Apiary
	{
	Designatedteam 0
	Species "BLUEMember"
	States
	{
	TargetCheck:
	GESP G 1 
	TRET A 0 //A_Jumpifintargetinventory("RespawnCamera",1,"Scan") //can't shoot what you can't see,
	TRET A 0 A_Jumpifintargetinventory("WilyTeamFlag",1,"Spotted") //found an enemy!
	TRET A 0 A_checkflag("IsMonster","Spotted",AAPTR_TARGET) //found an enemy!
	Goto Idle
	}
	}

actor A_BeeShot : ProjectileBase
{
Speed 15
Damage (5)
radius 8
+NOCLIP
Damagetype "A_Bee"
//MissileHeight 16
height 8
scale 1.8
Var int User_BeeTimer;
States
{
Spawn:
TNT1 A 0 
HCHS BC 2 A_SeekerMissile(4, 10, SMF_PRECISE)
BASB T 0 A_Changeflag("NOCLIP",0)
Spawn2:
HCHS BC 2 A_SeekerMissile(4, 10, SMF_PRECISE)
BASB T 0 A_SetUserVar("User_BeeTimer",User_BeeTimer+1)
BASB T 0 A_Jumpif(User_BeeTimer > 10,"Timeout")
Loop
Timeout:
TNT1 A 1 A_JumpifTracerCloser(150,"Spawn2")
TNT1 A 0 
stop
Death:
TNT1 A 1 //A_Spawnitemex("CrisperizerPuff1",0,0,0,0,0,0,0,SXF_TRANSFERTRANSLATION)
stop
}
}

actor HoneyDrop : SmallHealthC
{
inventory.pickupmessage "$PU_SMALLHEALTH"
+COUNTITEM
Scale 2.0
States
{
Spawn:
HONY ABABABA 5 
HONY BABABAB 5 
HONY ABABABA 5 
HONY BABABAB 5 
HONY AAZZABZZBBZZAAZZBBZZAAZZA 1 
STOP
Pickup:
TNT1 A 0 A_JumpIf(CallACS("GetHPPerc",0)<100,"HealMe")
//TNT1 A 0 A_JumpIfInventory("CanSnatch_F",1,"TheSnatch")
fail
//TheSnatch:
//TNT1 A 0 A_GiveInventory("SnatchItems_P1A",1)
stop
HealMe:
TNT1 A 0 A_PlaySound("item/energyup",3,1.0)
TNT1 A 0 HealThing(CallACS("GetHPPerc2",0,25))
stop
}
}

actor ApiaryMarker  // 
{
PROJECTILE
//+NOINTERACTION
+NOGRAVITY
//+FLOORHUGGER
+NOTARGETSWITCH
height 20
Radius 50
damage (0)
reactiontime 1
scale 1.5
RenderStyle "ADD"
Alpha 1
States
{
Spawn:
TREG A 0
TREG A 2 A_SpawnitemEx("AreaMarker", 0, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
stop
Crash:
XDeath:
TREG B 0 A_Changeflag("NOINTERACTION",1)
TREG B 1 A_GiveToTarget("SpawnDeny")
TNT1 A 1 A_SpawnitemEx("ApiaryMarker2", 0, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
Stop
Death:
TREG B 0 A_Changeflag("NOINTERACTION",1)
TREG B 1 A_GiveToTarget("SpawnDeny")
TNT1 A 1 A_SpawnitemEx("ApiaryMarker2", 0, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
stop
}
}

	actor ApiaryMarker_RED  : ApiaryMarker// 
	{
	States
	{
	Spawn:
	TREG A 0
	TREG A 2 A_SpawnitemEx("AreaMarker_RED", 0, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
	stop
	}
	}

	actor ApiaryMarker_BLUE  : ApiaryMarker// 
	{
	States
	{
	Spawn:
	TREG A 0
	TREG A 2 A_SpawnitemEx("AreaMarker_BLUE", 0, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
	stop
	}
	}

actor ApiaryMarker2  // 
{
PROJECTILE
+NOINTERACTION
+NOGRAVITY
//+FLOORHUGGER
+NOTARGETSWITCH
height 30
Radius 80
damage (0)
reactiontime 1
scale 1.5
RenderStyle "ADD"
Alpha 1
States
{
Spawn:
TREG B 2
stop
stop
}
}

actor ApiaryShooter : CustomInventory 
{
inventory.amount 1
Inventory.MaxAmount 100
+AUTOACTIVATE
States
{
Spawn:
TNT1 A 0
stop
Pickup:
BLTR C 0 A_JumpifinTargetinventory("WilyTeamFlag",1,"TeamRedFire")
BLTR C 0 A_JumpifinTargetinventory("LightTeamFlag",1,"TeamBlueFire")
BUST B 0 A_SpawnItemEx("HGHitbox1",cos(-pitch)*15,0,20+(sin(pitch)*15),cos(-pitch)*BEESHT_SPD,0,sin(pitch)*-BEESHT_SPD,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
stop
TeamRedFire:
BUST B 0 A_SpawnItemEx("HGHitbox1",cos(-pitch)*15,0,20+(sin(pitch)*15),cos(-pitch)*BEESHT_SPD,0,sin(pitch)*-BEESHT_SPD,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
TNT1 A 0
stop
TeamBlueFire:
BUST B 0 A_SpawnItemEx("HGHitbox1",cos(-pitch)*15,0,20+(sin(pitch)*15),cos(-pitch)*BEESHT_SPD,0,sin(pitch)*-BEESHT_SPD,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
TNT1 A 0
stop
}
}

actor ApiaryShooter2 : CustomInventory 
{
inventory.amount 1
Inventory.MaxAmount 100
+AUTOACTIVATE
States
{
Spawn:
TNT1 A 0
stop
Pickup:
BLTR C 0 A_JumpifinTargetinventory("WilyTeamFlag",1,"TeamRedFire")
BLTR C 0 A_JumpifinTargetinventory("LightTeamFlag",1,"TeamBlueFire")
BUST B 0 A_SpawnItemEx("A_BeeShot",cos(-pitch)*random(-30,30),0,random(20,40)+(sin(pitch)*random(-30,30)),cos(-pitch)*BEESHT_SPD2,0,sin(pitch)*-BEESHT_SPD2,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
stop
TeamRedFire:
BUST B 0 A_SpawnItemEx("A_BeeShot",cos(-pitch)*random(-30,30),0,random(20,40)+(sin(pitch)*random(-30,30)),cos(-pitch)*BEESHT_SPD2,0,sin(pitch)*-BEESHT_SPD2,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
TNT1 A 0
stop
TeamBlueFire:
BUST B 0 A_SpawnItemEx("A_BeeShot",cos(-pitch)*random(-30,30),0,random(20,40)+(sin(pitch)*random(-30,30)),cos(-pitch)*BEESHT_SPD2,0,sin(pitch)*-BEESHT_SPD2,0,SXF_TRANSFERPOINTERS|SXF_TRANSFERPITCH)
TNT1 A 0
stop
}
}

actor ApiaryChecker : CustomInventory  //checks if there is space to spawn the Apiary
{
inventory.amount 1
Inventory.MaxAmount 100
+AUTOACTIVATE
States
{
Spawn:
TNT1 A 0
stop
Pickup:
BLTR C 0 A_Jumpifinventory("WilyTeamFlag",1,"TeamRedFire")
BLTR C 0 A_Jumpifinventory("LightTeamFlag",1,"TeamBlueFire")
 "####" E 1 A_SpawnitemEx("ApiaryMarker", 120, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)

stop
TeamRedFire:
 "####" E 1 A_SpawnitemEx("ApiaryMarker_RED", 120, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
TNT1 A 0
stop
TeamBlueFire:
 "####" E 1 A_SpawnitemEx("ApiaryMarker_BLUE", 120, 0, 0, momx, momy, momz, 0, SXF_ABSOLUTEMOMENTUM, 0)
TNT1 A 0
stop
}
}


actor ApiaryPlanter : CustomInventory  //places a Apiary based on the team.
{
inventory.amount 1
Inventory.MaxAmount 100
+AUTOACTIVATE
States
{
Spawn:
TNT1 A 0
stop
Pickup:
BLTR C 0 A_Jumpifinventory("WilyTeamFlag",1,"TeamRedFire")
BLTR C 0 A_Jumpifinventory("LightTeamFlag",1,"TeamBlueFire")
//---otherwise, just place a blank one
GDTB A 0 A_SpawnItemEX("Apiary",120,0,0,0,0,0,0,SXF_SETMASTER)
stop
TeamRedFire:
GDTB A 0 A_SpawnItemEX("Apiary_R",120,0,0,0,0,0,0,SXF_SETMASTER)
TNT1 A 0
stop
TeamBlueFire:
GDTB A 0 A_SpawnItemEX("Apiary_B",120,0,0,0,0,0,0,SXF_SETMASTER)
TNT1 A 0
stop
}
}

actor ApiaryItemFire : CustomInventory 
{
Tag "Deploy Shield"
inventory.amount 1
inventory.maxamount 1
inventory.pickupmessage "$PU_ETANK"

inventory.icon "BARRI"
Inventory.PickupSound "item/1up"
+INVBAR
+COUNTITEM
scale 2.2
Radius 30
States
{
Spawn:
EBAL F 0 
EBAL F 0 Thing_ChangeTID(0,999)
EBAL FE 6
Goto Spawn+2
Use:
//TNT1 A 0 A_JumpIfInventory("LightScreenBossCooldownItem",1,"Nope")
//TNT1 A 0 A_JumpIfInventory("LightScreenActive",1,"Use2")
TNT1 A 0 A_Giveinventory("ApiaryPlanter")
fail
Death:
TNT1 A 0
stop
Nope:
TNT1 A 0 //A_Giveinventory("ErrorSoundCue")
fail
}
}
